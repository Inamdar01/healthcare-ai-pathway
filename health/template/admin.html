<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AI Healthcare</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .topnav {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .logo {
      font-size: 1.5rem;
      color: #4ecdc4;
      font-weight: bold;
    }
    .admin-info {
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
    }
    .admin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .logout-btn {
      background: rgba(255, 107, 107, 0.3);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      background: rgba(255, 107, 107, 0.5);
    }
    .main-content {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .dashboard-title {
      font-size: 2.5rem;
      color: white;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    .tab {
      flex: 1;
      padding: 15px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .tab:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    .tab.active {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      transition: transform 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .stat-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: white;
      margin-bottom: 10px;
    }
    .stat-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
    }
    .section-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .section-title {
      color: white;
      font-size: 1.8rem;
      font-weight: 600;
    }
    .search-box {
      padding: 10px 15px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      width: 250px;
    }
    .search-box::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      display: block;
    }
    .data-table thead {
      background: rgba(255, 255, 255, 0.1);
    }
    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
      color: white;
    }
    .data-table tbody tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    .data-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .status-badge {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-confirmed {
      background: #27ae60;
      color: white;
    }
    .status-pending {
      background: #f39c12;
      color: white;
    }
    .status-cancelled {
      background: #e74c3c;
      color: white;
    }
    .status-completed {
      background: #3498db;
      color: white;
    }
    .status-active {
      background: #27ae60;
      color: white;
    }
    .status-inactive {
      background: #e74c3c;
      color: white;
    }
    .action-btn {
      background: rgba(78, 205, 196, 0.3);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin: 0 3px;
      transition: all 0.3s ease;
    }
    .action-btn:hover {
      background: rgba(78, 205, 196, 0.5);
      transform: translateY(-2px);
    }
    .delete-btn {
      background: rgba(255, 107, 107, 0.3);
    }
    .delete-btn:hover {
      background: rgba(255, 107, 107, 0.5);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2rem;
    }
    .role-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .role-admin {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
    }
    .role-user {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .filter-btn:hover, .filter-btn.active {
      background: rgba(78, 205, 196, 0.3);
      border-color: #4ecdc4;
    }
    @media (max-width: 768px) {
      .main-content { padding: 20px; }
      .dashboard-title { font-size: 2rem; }
      .stats-grid { grid-template-columns: 1fr; }
      .data-table { font-size: 0.9rem; }
      .data-table th, .data-table td { padding: 10px; }
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <nav class="topnav">
    <div class="logo">
      <i class="fas fa-user-shield"></i> Admin Dashboard
    </div>
    <div class="admin-info">
      <div class="admin-avatar" id="adminAvatar">A</div>
      <span id="adminName">Admin</span>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>

  <div class="main-content">
    <div class="dashboard-header">
      <h1 class="dashboard-title">AI Healthcare Admin Panel</h1>
      <p style="color: rgba(255,255,255,0.8); font-size: 1.1rem;">Manage users, appointments, and monitor system activity</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('overview')">
        <i class="fas fa-chart-line"></i> Overview
      </button>
      <button class="tab" onclick="showTab('appointments')">
        <i class="fas fa-calendar-check"></i> Appointments
      </button>
      <button class="tab" onclick="showTab('users')">
        <i class="fas fa-users"></i> Users
      </button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="color: #4ecdc4;">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="color: #27ae60;">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-value" id="totalAppointments">0</div>
          <div class="stat-label">Total Appointments</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="color: #f39c12;">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-value" id="todayAppointments">0</div>
          <div class="stat-label">Today's Appointments</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="color: #e74c3c;">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="stat-value" id="totalRevenue">₹0</div>
          <div class="stat-label">Total Revenue</div>
        </div>
      </div>

      <div class="section-card">
        <h3 class="section-title" style="margin-bottom: 20px;">Recent Appointments</h3>
        <div id="recentAppointmentsContainer">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading recent appointments...
          </div>
        </div>
      </div>
    </div>

    <!-- Appointments Tab -->
    <div id="appointments" class="tab-content">
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">All Appointments</h2>
          <input type="text" class="search-box" id="searchAppointments" placeholder="Search appointments..." onkeyup="searchAppointments()">
        </div>

        <div class="filter-group" style="margin-bottom: 20px;">
          <button class="filter-btn active" onclick="filterAppointments('all')">All</button>
          <button class="filter-btn" onclick="filterAppointments('confirmed')">Confirmed</button>
          <button class="filter-btn" onclick="filterAppointments('pending')">Pending</button>
          <button class="filter-btn" onclick="filterAppointments('completed')">Completed</button>
          <button class="filter-btn" onclick="filterAppointments('cancelled')">Cancelled</button>
        </div>

        <div id="appointmentsTableContainer">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading appointments...
          </div>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">Registered Users</h2>
          <input type="text" class="search-box" id="searchUsers" placeholder="Search users..." onkeyup="searchUsers()">
        </div>

        <div id="usersTableContainer">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading users...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA0FwyvLAtL2OV0DHdzmhZPgzurn0GwubU",
      authDomain: "ai-healthcare-dd4da.firebaseapp.com",
      projectId: "ai-healthcare-dd4da",
      storageBucket: "ai-healthcare-dd4da.firebasestorage.app",
      messagingSenderId: "811932137178",
      appId: "1:811932137178:web:5fd25a14f8bb556e4857e3",
      measurementId: "G-C08EYLKX26"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allUsers = [];
    let allAppointments = [];
    let currentFilter = 'all';

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.data();
      
      if (userData.role !== 'admin') {
        alert('Access denied. Admin privileges required.');
        window.location.href = 'home.html';
        return;
      }

      document.getElementById('adminName').textContent = userData.name;
      const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('adminAvatar').textContent = initials;

      loadDashboardData();
    });

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    async function loadDashboardData() {
      try {
        const [usersSnapshot, appointmentsSnapshot] = await Promise.all([
          db.collection('users').get(),
          db.collection('appointments').get()
        ]);

        allUsers = [];
        usersSnapshot.forEach(doc => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });

        allAppointments = [];
        let totalRevenue = 0;
        let todayCount = 0;
        const today = new Date().toISOString().split('T')[0];

        appointmentsSnapshot.forEach(doc => {
          const data = doc.data();
          allAppointments.push({ id: doc.id, ...data });
          totalRevenue += data.consultationFee || 0;
          
          if (data.appointmentDate === today) {
            todayCount++;
          }
        });

        allAppointments.sort((a, b) => {
          const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
          const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
          return dateB - dateA;
        });

        document.getElementById('totalUsers').textContent = allUsers.length;
        document.getElementById('totalAppointments').textContent = allAppointments.length;
        document.getElementById('todayAppointments').textContent = todayCount;
        document.getElementById('totalRevenue').textContent = '₹' + totalRevenue.toLocaleString();

        displayRecentAppointments();
        displayAppointments(allAppointments);
        displayUsers(allUsers);
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Error loading dashboard data. Please refresh the page.');
      }
    }

    function displayRecentAppointments() {
      const container = document.getElementById('recentAppointmentsContainer');
      const recent = allAppointments.slice(0, 5);

      if (recent.length === 0) {
        container.innerHTML = '<div class="loading">No appointments yet.</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Appointment ID</th>
              <th>Patient</th>
              <th>Doctor</th>
              <th>Date & Time</th>
              <th>Status</th>
              <th>Fee</th>
            </tr>
          </thead>
          <tbody>
      `;

      recent.forEach(apt => {
        const statusClass = `status-${apt.status || 'pending'}`;
        html += `
          <tr>
            <td><strong>${apt.appointmentId}</strong></td>
            <td>${apt.patientName}</td>
            <td>${apt.doctorName}</td>
            <td>${formatDate(apt.appointmentDate)} ${apt.appointmentTime}</td>
            <td><span class="status-badge ${statusClass}">${(apt.status || 'pending').toUpperCase()}</span></td>
            <td>₹${apt.consultationFee}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function displayAppointments(appointments) {
      const container = document.getElementById('appointmentsTableContainer');
      
      if (appointments.length === 0) {
        container.innerHTML = '<div class="loading">No appointments found.</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Patient</th>
              <th>Contact</th>
              <th>Doctor</th>
              <th>Specialization</th>
              <th>Date</th>
              <th>Time</th>
              <th>Type</th>
              <th>Status</th>
              <th>Fee</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      appointments.forEach(apt => {
        const statusClass = `status-${apt.status || 'pending'}`;
        html += `
          <tr>
            <td><strong>${apt.appointmentId}</strong></td>
            <td>
              <div>${apt.patientName}</div>
              <div style="font-size: 0.85rem; opacity: 0.8;">Age: ${apt.patientAge}</div>
            </td>
            <td>
              <div style="font-size: 0.9rem;">${apt.patientPhone}</div>
              <div style="font-size: 0.85rem; opacity: 0.8;">${apt.patientEmail}</div>
            </td>
            <td>${apt.doctorName}</td>
            <td>${apt.specialization}</td>
            <td>${formatDate(apt.appointmentDate)}</td>
            <td>${apt.appointmentTime}</td>
            <td>${formatAppointmentType(apt.appointmentType)}</td>
            <td><span class="status-badge ${statusClass}">${(apt.status || 'pending').toUpperCase()}</span></td>
            <td>₹${apt.consultationFee}</td>
            <td>
              <button class="action-btn" onclick="viewAppointmentDetails('${apt.id}')" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn" onclick="updateAppointmentStatus('${apt.id}')" title="Update Status">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete-btn" onclick="deleteAppointment('${apt.id}', '${apt.appointmentId}')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function displayUsers(users) {
      const container = document.getElementById('usersTableContainer');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="loading">No users found.</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Registered</th>
              <th>Last Login</th>
              <th>Login Count</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      users.forEach(user => {
        const createdDate = user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A';
        const lastLogin = user.lastLogin ? user.lastLogin.toDate().toLocaleString() : 'Never';
        const loginCount = user.loginCount || 0;
        const statusClass = user.isActive ? 'status-active' : 'status-inactive';
        const statusText = user.isActive ? 'Active' : 'Inactive';
        const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';

        html += `
          <tr>
            <td><strong>${user.name}</strong></td>
            <td>${user.email}</td>
            <td><span class="role-badge ${roleClass}">${user.role || 'user'}</span></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${createdDate}</td>
            <td>${lastLogin}</td>
            <td>${loginCount}</td>
            <td>
              ${user.role !== 'admin' ? `
                <button class="action-btn" onclick="toggleUserStatus('${user.id}', ${!user.isActive})">
                  <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i>
                </button>
                <button class="action-btn" onclick="makeAdmin('${user.id}')">
                  <i class="fas fa-user-shield"></i>
                </button>
                <button class="action-btn delete-btn" onclick="deleteUser('${user.id}', '${user.name}')">
                  <i class="fas fa-trash"></i>
                </button>
              ` : '<span style="color: rgba(255,255,255,0.5);">Admin</span>'}
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatAppointmentType(type) {
      const typeMap = {
        'first': 'First Visit',
        'followup': 'Follow-up',
        'emergency': 'Emergency'
      };
      return typeMap[type] || type;
    }

    function filterAppointments(status) {
      currentFilter = status;
      
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      let filtered = allAppointments;
      if (status !== 'all') {
        filtered = allAppointments.filter(apt => apt.status === status);
      }

      displayAppointments(filtered);
    }

    function searchAppointments() {
      const searchTerm = document.getElementById('searchAppointments').value.toLowerCase();
      let filtered = allAppointments;

      if (currentFilter !== 'all') {
        filtered = filtered.filter(apt => apt.status === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(apt => 
          apt.appointmentId.toLowerCase().includes(searchTerm) ||
          apt.patientName.toLowerCase().includes(searchTerm) ||
          apt.doctorName.toLowerCase().includes(searchTerm) ||
          apt.patientPhone.includes(searchTerm)
        );
      }

      displayAppointments(filtered);
    }

    function searchUsers() {
      const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
      const filtered = allUsers.filter(user => 
        user.name.toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm) ||
        (user.role && user.role.toLowerCase().includes(searchTerm))
      );
      displayUsers(filtered);
    }

    function viewAppointmentDetails(appointmentId) {
      const appointment = allAppointments.find(a => a.id === appointmentId);
      if (!appointment) return;

      alert(`Appointment Details:\n\n` +
        `ID: ${appointment.appointmentId}\n` +
        `Patient: ${appointment.patientName} (Age: ${appointment.patientAge})\n` +
        `Contact: ${appointment.patientPhone}\n` +
        `Email: ${appointment.patientEmail}\n` +
        `Doctor: ${appointment.doctorName}\n` +
        `Specialization: ${appointment.specialization}\n` +
        `Date: ${formatDate(appointment.appointmentDate)}\n` +
        `Time: ${appointment.appointmentTime}\n` +
        `Type: ${formatAppointmentType(appointment.appointmentType)}\n` +
        `Reason: ${appointment.reasonForVisit}\n` +
        `Medical History: ${appointment.medicalHistory || 'None'}\n` +
        `Fee: ₹${appointment.consultationFee}\n` +
        `Status: ${(appointment.status || 'pending').toUpperCase()}`
      );
    }

    async function updateAppointmentStatus(appointmentId) {
      const appointment = allAppointments.find(a => a.id === appointmentId);
      if (!appointment) return;

      const newStatus = prompt(
        `Update appointment status for ${appointment.appointmentId}:\n\n` +
        `Current Status: ${(appointment.status || 'pending').toUpperCase()}\n\n` +
        `Enter new status:\n` +
        `- confirmed\n` +
        `- pending\n` +
        `- completed\n` +
        `- cancelled`,
        appointment.status || 'pending'
      );

      if (!newStatus || !['confirmed', 'pending', 'completed', 'cancelled'].includes(newStatus.toLowerCase())) {
        if (newStatus !== null) alert('Invalid status. Please enter: confirmed, pending, completed, or cancelled');
        return;
      }

      try {
        await db.collection('appointments').doc(appointmentId).update({
          status: newStatus.toLowerCase(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Appointment status updated successfully!');
        loadDashboardData();
      } catch (error) {
        console.error('Error updating appointment:', error);
        alert('Error updating appointment status. Please try again.');
      }
    }

    async function deleteAppointment(appointmentId, aptId) {
      if (!confirm(`Are you sure you want to delete appointment ${aptId}?\n\nThis action cannot be undone.`)) {
        return;
      }

      const confirmText = prompt('Type "DELETE" to confirm deletion:');
      if (confirmText !== 'DELETE') {
        alert('Deletion cancelled.');
        return;
      }

      try {
        await db.collection('appointments').doc(appointmentId).delete();
        alert('Appointment deleted successfully!');
        loadDashboardData();
      } catch (error) {
        console.error('Error deleting appointment:', error);
        alert('Error deleting appointment. Please try again.');
      }
    }

    async function toggleUserStatus(userId, newStatus) {
      if (!confirm(`Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} this user?`)) {
        return;
      }

      try {
        await db.collection('users').doc(userId).update({
          isActive: newStatus
        });
        
        alert(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
        loadDashboardData();
      } catch (error) {
        console.error('Error updating user status:', error);
        alert('Error updating user status. Please try again.');
      }
    }

    async function makeAdmin(userId) {
      if (!confirm('Are you sure you want to make this user an admin? This will grant them full access to the admin dashboard.')) {
        return;
      }

      try {
        await db.collection('users').doc(userId).update({
          role: 'admin'
        });
        
        alert('User promoted to admin successfully!');
        loadDashboardData();
      } catch (error) {
        console.error('Error promoting user:', error);
        alert('Error promoting user. Please try again.');
      }
    }

    async function deleteUser(userId, userName) {
      if (!confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`)) {
        return;
      }

      const confirmText = prompt('Type "DELETE" to confirm deletion:');
      if (confirmText !== 'DELETE') {
        alert('Deletion cancelled.');
        return;
      }

      try {
        await db.collection('users').doc(userId).delete();
        alert('User deleted successfully!');
        loadDashboardData();
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('Error deleting user. Please try again.');
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      }
    }
  </script>
</body>
</html>